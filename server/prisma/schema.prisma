generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  STAFF
}

enum AcademicYearStatus {
  OPEN
  CLOSED
}

enum FlowStatus {
  OPEN
  SETTLED
}

enum PaymentMode {
  CASH
  UPI
  BANK
  CHEQUE
}

enum DocumentKind {
  INVOICE
  ESTIMATION
  CREDIT_NOTE
  PAYMENT
}

enum InvoiceStatus {
  ISSUED
  VOIDED
}

enum PaymentStatus {
  POSTED
  REVERSED
}

model Settings {
  id String @id @default(uuid())

  name  String
  phone String
  email String?
  gst   String?

  town     String?
  district String?
  state    String?
  pincode  String?

  bankName  String?
  accountNo String?
  ifsc      String?
  upi       String?

  phoneSecondary String?
  phoneTertiary  String?

  logoUrl   String?
  qrCodeUrl String?

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt
}

model User {
  id String @id @default(uuid())

  name     String
  phone    String  @unique
  email    String?
  password String

  role UserRole

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt

  billedInvoices Invoice[] @relation(name: "UserBilledInvoices")
  voidedInvoices Invoice[] @relation(name: "UserVoidedInvoices")

  recordedPayments Payment[] @relation(name: "UserRecordedPayments")
  reversedPayments Payment[] @relation(name: "UserReversedPayments")

  @@index([id])
  @@index([phone])
  @@index([role])
}

// ================= ACADEMIC YEAR =================

model AcademicYear {
  id        String             @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  status    AcademicYearStatus @default(OPEN)

  flows    FlowGroup[]
  payments Payment[]

  documentSequences DocumentSequence[]

  createdAt DateTime  @default(now())
  closedAt  DateTime?

  @@index([startDate, endDate])
}

// ================= CUSTOMER =================

model School {
  id String @id @default(uuid())

  name          String
  phone         String
  email         String?
  contactPerson String?

  street   String?
  town     String?
  district String?
  state    String?
  pincode  String?

  gst    String?
  board  String?
  medium String?

  active        Boolean   @default(true)
  deactivatedAt DateTime?

  flows FlowGroup[]

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt

  @@index([phone])
  @@index([email])
  @@index([gst])
  @@index([active])
  @@index([district, state])
}

// ================= DEALER =================

model Company {
  id String @id @default(uuid())

  name  String
  phone String
  email String?

  street   String?
  town     String?
  district String?
  state    String?
  pincode  String?

  gst String?

  bankName  String?
  accountNo String?
  ifsc      String?

  active        Boolean   @default(true)
  deactivatedAt DateTime?

  flows FlowGroup[]

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt

  @@index([phone])
  @@index([email])
  @@index([gst])
  @@index([active])
  @@index([district, state])
}

// ================= FLOW GROUP =================
// ONE complete settlement cycle

model FlowGroup {
  id String @id @default(uuid())

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  description String?
  status      FlowStatus @default(OPEN)

  invoice  Invoice[]
  payments Payment[]

  createdAt DateTime @default(now())

  @@index([academicYearId])
  @@index([companyId])
  @@index([schoolId])
}

// ================= INVOICE =================

model Invoice {
  id         String   @id @default(uuid())
  documentNo String
  date       DateTime

  flowGroupId String
  flowGroup   FlowGroup @relation(fields: [flowGroupId], references: [id])

  kind   DocumentKind
  status InvoiceStatus @default(ISSUED)

  items Item[]

  totalQuantity Int
  grossAmount   Decimal @db.Decimal(12, 2)
  totalDiscount Decimal @db.Decimal(12, 2)
  netAmount     Decimal @db.Decimal(12, 2)

  notes String?

  billedByUserId String
  billedByUser   User   @relation(name: "UserBilledInvoices", fields: [billedByUserId], references: [id])

  voidedAt       DateTime?
  voidedByUserId String?
  voidedByUser   User?     @relation(name: "UserVoidedInvoices", fields: [voidedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([flowGroupId])
}

// ================= PROVISIONAL INVOICE ITEM =================

model Item {
  id String @id @default(uuid())

  description String
  class       String?
  company     String?

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  quantity Int

  unitPrice Decimal @db.Decimal(10, 2)

  discountPercent Decimal @db.Decimal(5, 2)

  grossAmount Decimal @db.Decimal(12, 2)
  netAmount   Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  @@index([invoiceId])
}

// ================= PAYMENT =================

model Payment {
  id String @id @default(uuid())

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  flowGroupId String
  flowGroup   FlowGroup @relation(fields: [flowGroupId], references: [id])

  receiptNo Decimal @db.Decimal(12, 2)

  amount Decimal       @db.Decimal(12, 2)
  mode   PaymentMode
  status PaymentStatus @default(POSTED)

  note String?

  recordedByUserId String
  recordedByUser   User   @relation(name: "UserRecordedPayments", fields: [recordedByUserId], references: [id])

  reversedAt       DateTime?
  reversedByUserId String?
  reversedByUser   User?     @relation(name: "UserReversedPayments", fields: [reversedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([academicYearId])
  @@index([flowGroupId])
}

// ================= EXPENSE =================

model DocumentSequence {
  id String @id @default(uuid())

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  type       DocumentKind
  lastNumber Int

  updatedAt DateTime @updatedAt

  @@unique([academicYearId, type])
}
